# Ergo v1.5 - 实时监控与自动化

**规划日期**：2026-02-20
**状态**：📋 规划中

---

## 📋 概述

v1.5 将 Ergo 从"静态项目管理"升级为**实时监控与智能自动化中心**，让用户从"手动操作者"变为"监督者"。

### 核心改进

| 维度 | v1.4（当前） | v1.5（目标） |
|------|-------------|-------------|
| **状态更新** | 手动刷新 | WebSocket 实时推送 |
| **操作方式** | 多步骤跳转 | 一键快速操作 |
| **异常感知** | 被动查看 | 主动通知提醒 |
| **多项目管理** | 逐个点击 | 聚合仪表盘 |

---

## ✨ 核心功能

### 1. 🔄 WebSocket 实时连接（P0）

**当前痛点**：用户需要频繁刷新页面才能看到最新状态

**解决方案**：
- ✅ WebSocket 长连接，状态自动推送
- ✅ 断线自动重连（指数退避策略）
- ✅ 连接状态可视化（在线/离线）
- ✅ 文件监听：`project-status.json` 变更立即推送

**用户体验**：
- 打开页面后，永远看到的都是实时数据
- 服务状态、测试结果、构建状态即时更新
- 无需手动刷新，减少操作 80%

---

### 2. ⚡ 快速操作面板（P1）

**当前痛点**：发现问题后需要打开终端/SSH 手动重启服务

**解决方案**：
- ✅ 一键重启 Gateway
- ✅ 一键触发 Cron 任务
- ✅ 操作确认对话框
- ✅ 实时反馈（Toast 通知）

**用户体验**：
- 发现 Gateway 离线 → 点击"重启" → 30 秒后自动恢复
- 想立即执行任务 → 点击"触发" → 任务立即执行
- 所有操作 2 秒内完成，无需离开浏览器

**实现的 API**：
```
POST /api/gateway/restart      - 重启 Gateway
POST /api/cron/:jobId/trigger  - 触发 Cron 任务
```

---

### 3. 🔔 浏览器通知（P1）

**当前痛点**：错过重要事件（服务挂掉、任务失败）

**解决方案**：
- ✅ 浏览器原生通知（Notification API）
- ✅ 异常实时提醒（服务停止、健康度下降）
- ✅ 通知点击跳转到对应项目
- ✅ 智能去重（同类通知 5 分钟内只发一次）

**通知场景**：
- ⚠️ 项目健康度从 healthy → unhealthy
- 🛑 服务停止运行
- ❌ Gateway 离线
- ⏰ Cron 任务执行失败

**用户体验**：
- 在其他应用工作时，Ergo 在后台监控
- 出现异常立即收到通知，第一时间响应
- 点击通知直接跳转到问题项目，快速处理

---

### 4. 📊 多项目仪表盘（P2）

**当前痛点**：管理多个项目需要逐个点击查看，效率低

**解决方案**：
- ✅ 所有项目聚合视图
- ✅ 卡片式布局，一目了然
- ✅ 健康度、服务状态、测试结果一览
- ✅ 实时更新（WebSocket 驱动）

**页面布局**：
```
┌─────────────────────────────────────────────┐
│  📊 项目概览                     [刷新] [⚙️]│
├─────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐          │
│  │ Ergo        │  │ Cargo       │          │
│  │ ✅ 健康      │  │ ⚠️ 降级      │          │
│  │ 3/3 服务    │  │ 1/2 服务    │          │
│  │ 34/34 测试  │  │ 12/15 测试  │          │
│  └─────────────┘  └─────────────┘          │
│  ...更多项目...                             │
└─────────────────────────────────────────────┘
```

**用户体验**：
- 一个页面掌控所有项目
- 健康项目显示绿色，异常项目显示红色
- 点击卡片进入详情页

---

## 🔧 技术架构

### 前端

**新增文件**：
- `src/realtime.js` - WebSocket 客户端封装
- `src/notifications.js` - 浏览器通知管理
- `dashboard.html` - 多项目仪表盘

**核心技术**：
- WebSocket API（实时连接）
- Notification API（浏览器通知）
- 指数退避重连策略
- 事件驱动架构

### 后端

**扩展文件**：
- `server/api-bridge.js` (+200 行)

**核心技术**：
- `ws` - WebSocket Server
- `chokidar` - 文件监听
- 心跳机制（30 秒一次）
- 广播机制（多客户端同步）

**新增依赖**：
```json
{
  "dependencies": {
    "ws": "^8.x",
    "chokidar": "^3.x"
  }
}
```

---

## 🚀 使用场景

### 场景 1: 早晨检查（陈磊的典型工作流）

**v1.4（当前）**：
1. 打开 Ergo 首页
2. 逐个点击项目查看状态（4 个项目 = 4 次点击）
3. 发现 Cargo 项目服务停止
4. 打开终端，SSH 到服务器
5. 执行重启命令
6. 返回 Ergo 刷新页面确认

**用时**：~5 分钟

**v1.5（优化后）**：
1. 打开 Ergo Dashboard（仪表盘）
2. 一眼看到 Cargo 显示 ⚠️ 降级
3. 点击卡片进入详情
4. 点击"重启服务"按钮
5. 收到 Toast：✅ 服务重启成功

**用时**：~30 秒 ⚡ 节省 90% 时间

---

### 场景 2: 远程办公时异常处理

**v1.4（当前）**：
- 陈磊在公司，家里的 Gateway 突然挂了
- 30 分钟后回家才发现问题
- 损失：AI 任务停摆 30 分钟

**v1.5（优化后）**：
- Gateway 离线后，立即收到浏览器通知 🔔
- 陈磊在开会，手机震动提醒
- 休息时打开 Ergo，点击"重启 Gateway"
- 2 分钟内恢复服务

**损失**：仅 2 分钟 ✅ 减少 93% downtime

---

### 场景 3: 多项目状态监控

**v1.4（当前）**：
- 管理 4 个项目，每个都要点进去看
- 不知道哪个项目有问题，需要全部检查
- 效率低

**v1.5（优化后）**：
- 打开 Dashboard，4 个项目卡片并排显示
- Ergo ✅、Cargo ⚠️、PingCode ❌、Best Practices ✅
- 一眼看出 PingCode 异常，直接处理

---

## 📅 开发计划

### Phase 1: WebSocket 实时连接（3-4h）
- 集成 WebSocket Server
- 实现客户端自动重连
- 添加连接状态指示器
- 文件监听 + 状态推送

### Phase 2: 快速操作功能（2-3h）
- 一键重启 Gateway
- 一键触发 Cron 任务
- 操作确认 + Toast 反馈

### Phase 3: 浏览器通知（2-3h）
- 通知权限请求
- 异常事件监听
- 通知点击跳转

### Phase 4: 多项目仪表盘（3-4h）
- Dashboard 页面布局
- 聚合视图渲染
- 实时更新逻辑

**总计**：10-14 小时（2-3 个工作日）

---

## ✅ 成功指标

### 定量指标

- ✅ 状态更新延迟 < 1 秒（实时推送）
- ✅ 操作完成时间 < 5 秒（快速操作）
- ✅ 异常响应时间 < 30 秒（从发生到处理）
- ✅ 多项目查看时间减少 80%（仪表盘）

### 定性指标

- ✅ 陈磊："再也不用频繁刷新了"
- ✅ 陈磊："发现问题后立即能处理，不用打开终端"
- ✅ 陈磊："出现异常立即就知道了，不会错过"

---

## 🚨 注意事项

### 浏览器兼容性

- WebSocket：支持所有现代浏览器（IE 除外）
- Notification：需要 HTTPS 或 localhost
- 建议浏览器：Chrome 90+、Edge 90+、Safari 14+

### 安全性

- WebSocket 连接需要认证（X-Ergo-Key）
- 通知权限需要用户主动授权
- 敏感操作（重启 Gateway）需要二次确认

### 性能考虑

- WebSocket 心跳频率：30 秒（平衡性能和实时性）
- 文件监听防抖：500ms（避免事件风暴）
- 通知去重：5 分钟（避免通知过多）

---

## 📚 相关文档

- [功能规划](./feature-plan.md) - 详细技术设计
- [ROADMAP](../../product/ROADMAP.md) - 产品路线图
- [Persona](../../product/persona.md) - 用户画像

---

**规划状态**：✅ 完成
**下一步**：等待用户确认后开始实施
