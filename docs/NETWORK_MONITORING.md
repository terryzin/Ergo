# ç½‘ç»œçŠ¶æ€ç›‘æ§ä¼˜åŒ–

## ğŸ“Š ä¼˜åŒ–æ¦‚è¿°

**v1.3.0+** å°†ç½‘ç»œçŠ¶æ€ç›‘æ§åˆ†ç¦»ä¸ºä¸¤ä¸ªç‹¬ç«‹çš„æŒ‡æ ‡ï¼Œæä¾›æ›´ç²¾ç¡®çš„ç³»ç»ŸçŠ¶æ€åé¦ˆã€‚

### ä¹‹å‰ï¼ˆå•ä¸€æŒ‡æ ‡ï¼‰
```
ç½‘ç»œ: ç¼“å­˜  â† æ··æ·†äº†è¿é€šæ€§å’Œæ•°æ®æ–°é²œåº¦
```

### ä¼˜åŒ–åï¼ˆåŒæŒ‡æ ‡ï¼‰
```
ç½‘ç»œ: åœ¨çº¿ (25ms)  â† å®æ—¶æ£€æµ‹ API Bridge è¿é€šæ€§
æ•°æ®: ç¼“å­˜ (142s)  â† æ˜¾ç¤ºæ•°æ®æ–°é²œåº¦å’Œç¼“å­˜å¹´é¾„
```

---

## ğŸ¯ è®¾è®¡ç†å¿µ

### èŒè´£åˆ†ç¦»
| æŒ‡æ ‡ | å«ä¹‰ | æ£€æµ‹æ–¹å¼ | æ›´æ–°é¢‘ç‡ |
|------|------|----------|----------|
| **ç½‘ç»œ** | API Bridge æ˜¯å¦å¯è¾¾ | `/api/health` å¿«é€Ÿæ£€æµ‹ | æ¯ 3 ç§’ |
| **æ•°æ®** | æ•°æ®æ˜¯å®æ—¶è¿˜æ˜¯ç¼“å­˜ | `_meta.cached` æ ‡å¿— | æ¯ 10 ç§’ |

### ç”¨æˆ·ä»·å€¼
- âœ… **å³æ—¶åé¦ˆ** - 3ç§’å†…çŸ¥é“ç½‘ç»œæ˜¯å¦æ­£å¸¸
- âœ… **ç²¾ç¡®çŠ¶æ€** - æ¸…æ¥šåŒºåˆ†è¿é€šæ€§å’Œæ•°æ®æ–°é²œåº¦
- âœ… **å»¶è¿Ÿå¯è§** - æ˜¾ç¤ºç½‘ç»œå“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- âœ… **ç¼“å­˜é€æ˜** - æ˜¾ç¤ºæ•°æ®ç¼“å­˜äº†å¤šä¹…

---

## ğŸ”§ æŠ€æœ¯å®ç°

### å‰ç«¯å®ç°

**ç½‘ç»œå¥åº·æ£€æŸ¥ï¼ˆæ–°å¢ï¼‰ï¼š**
```javascript
async function checkNetworkHealth() {
    try {
        const start = Date.now();
        const response = await fetch('/api/health', {
            method: 'GET',
            signal: AbortSignal.timeout(3000)  // 3ç§’è¶…æ—¶
        });

        const latency = Date.now() - start;

        if (response.ok) {
            document.getElementById('networkStatus').textContent = 'åœ¨çº¿';
            document.getElementById('networkPill').innerHTML =
                `<span class="status-dot"></span><span>${latency}ms</span>`;
            document.getElementById('networkPill').className = 'status-pill ok';
            return true;
        }
    } catch (error) {
        document.getElementById('networkStatus').textContent = 'ç¦»çº¿';
        document.getElementById('networkPill').innerHTML = '<span>è¿æ¥å¤±è´¥</span>';
        document.getElementById('networkPill').className = 'status-pill err';
        return false;
    }
}

// æ¯ 3 ç§’æ£€æµ‹ä¸€æ¬¡
setInterval(checkNetworkHealth, 3000);
```

**æ•°æ®çŠ¶æ€æ˜¾ç¤ºï¼ˆä¿®æ”¹ï¼‰ï¼š**
```javascript
async function loadData(forceRefresh = false) {
    const data = await fetchAllData(forceRefresh);
    const isCached = data._meta?.cached || false;
    const cacheAge = data._meta?.cacheAge;

    if (hasError) {
        document.getElementById('dataStatus').textContent = 'å¼‚å¸¸';
        document.getElementById('dataPill').innerHTML = '<span>åŠ è½½å¤±è´¥</span>';
        document.getElementById('dataPill').className = 'status-pill err';
    } else {
        const statusText = isCached ? 'ç¼“å­˜' : 'å®æ—¶';
        const pillText = isCached && cacheAge ? `ç¼“å­˜ ${cacheAge}s` : statusText;

        document.getElementById('dataStatus').textContent = statusText;
        document.getElementById('dataPill').innerHTML =
            `<span class="status-dot"></span><span>${pillText}</span>`;
        document.getElementById('dataPill').className =
            isCached ? 'status-pill' : 'status-pill ok';
    }
}

// æ¯ 10 ç§’åˆ·æ–°ä¸€æ¬¡
setInterval(loadData, 10000);
```

### åç«¯å®ç°

**API Bridge æ–°å¢ç«¯ç‚¹ï¼š**
```javascript
// è®¤è¯ä¸­é—´ä»¶ - è±å… health ç«¯ç‚¹
function authMiddleware(req, res, next) {
    if (req.path === '/health' || req.path === '/api/health') {
        return next();  // æ— éœ€è®¤è¯
    }
    // ... å…¶ä»–è·¯ç”±éœ€è¦è®¤è¯
}

/**
 * GET /api/health
 * API å¥åº·æ£€æŸ¥ï¼ˆæ— éœ€è®¤è¯ï¼Œç”¨äºå‰ç«¯å¿«é€Ÿæ£€æµ‹ï¼‰
 */
app.get('/api/health', (req, res) => {
    res.json({
        status: 'ok',
        timestamp: new Date().toISOString()
    });
});
```

---

## ğŸ“± UI å±•ç¤º

### KPI å¡ç‰‡å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gateway         Agents         Cron        â”‚
â”‚  è¿è¡Œä¸­          3 ä¸ª            5 ä¸ª        â”‚
â”‚  â— åœ¨çº¿          â— 3 åœ¨çº¿        â— 4 è¿è¡Œä¸­  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç½‘ç»œ            æ•°æ®                        â”‚
â”‚  åœ¨çº¿            ç¼“å­˜                        â”‚
â”‚  â— 25ms          â— ç¼“å­˜ 142s                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### çŠ¶æ€é¢œè‰²

| ç½‘ç»œçŠ¶æ€ | æ˜¾ç¤º | é¢œè‰² |
|----------|------|------|
| åœ¨çº¿ | åœ¨çº¿ (XXms) | ç»¿è‰² â— |
| ç¦»çº¿ | è¿æ¥å¤±è´¥ | çº¢è‰² âš ï¸ |

| æ•°æ®çŠ¶æ€ | æ˜¾ç¤º | é¢œè‰² |
|----------|------|------|
| å®æ—¶ | å®æ—¶ | ç»¿è‰² â— |
| ç¼“å­˜ | ç¼“å­˜ (XXs) | è“è‰² â— |
| å¼‚å¸¸ | åŠ è½½å¤±è´¥ | çº¢è‰² âš ï¸ |

---

## ğŸš€ æ€§èƒ½ä¸èµ„æº

### ç½‘ç»œå¼€é”€

**ä¹‹å‰ï¼ˆå•ä¸€æ£€æµ‹ï¼‰ï¼š**
```
æ¯ 10 ç§’ï¼š1 æ¬¡ /api/status è¯·æ±‚ï¼ˆéœ€è®¤è¯ï¼Œ~500msï¼‰
```

**ä¼˜åŒ–åï¼ˆåŒé‡æ£€æµ‹ï¼‰ï¼š**
```
æ¯ 3 ç§’ï¼š 1 æ¬¡ /api/health è¯·æ±‚ï¼ˆæ— éœ€è®¤è¯ï¼Œ~25msï¼‰
æ¯ 10 ç§’ï¼š1 æ¬¡ /api/status è¯·æ±‚ï¼ˆéœ€è®¤è¯ï¼Œ~500msï¼‰
```

**åˆ†æï¼š**
- ç½‘ç»œæ£€æµ‹é¢‘ç‡æé«˜ 3.3 å€ï¼ˆ10s â†’ 3sï¼‰
- å•æ¬¡å»¶è¿Ÿé™ä½ 20 å€ï¼ˆ500ms â†’ 25msï¼‰
- å¸¦å®½å¢åŠ ï¼šæ¯åˆ†é’Ÿå¢åŠ  ~2KBï¼ˆ20 æ¬¡ health è¯·æ±‚ï¼‰
- **æ€»ä½“å½±å“ï¼š** å¾®å°ï¼ˆ< 0.1 KB/sï¼‰ï¼Œç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

### æœåŠ¡å™¨è´Ÿè½½

**API Bridge è´Ÿè½½ï¼š**
```
/api/health ç«¯ç‚¹ï¼š
- æ— éœ€è®¤è¯æ£€æŸ¥
- æ— éœ€ CLI è°ƒç”¨
- æ— éœ€æ•°æ®åº“æŸ¥è¯¢
- ä»…è¿”å› JSONï¼š~60 å­—èŠ‚
```

**ä¼°ç®—å“åº”æ—¶é—´ï¼š**
- æœ¬åœ°è®¿é—®ï¼š< 10ms
- å…¬ç½‘è®¿é—®ï¼ˆcpolarï¼‰ï¼š20-50ms

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šç½‘ç»œæ•…éšœè¯Šæ–­

**é—®é¢˜ï¼š** é¡µé¢æ˜¾ç¤º"åŠ è½½å¤±è´¥"

**æ’æŸ¥ï¼š**
1. æŸ¥çœ‹"ç½‘ç»œ"æŒ‡æ ‡ï¼š
   - âœ… **åœ¨çº¿** â†’ API Bridge æ­£å¸¸ï¼Œé—®é¢˜åœ¨ Gateway
   - âŒ **ç¦»çº¿** â†’ API Bridge æ•…éšœæˆ– cpolar éš§é“æ–­å¼€

2. æŸ¥çœ‹"æ•°æ®"æŒ‡æ ‡ï¼š
   - **å¼‚å¸¸** â†’ Gateway ä¸å¯è¾¾æˆ– CLI å¤±è´¥

### åœºæ™¯ 2ï¼šç¼“å­˜éªŒè¯

**é—®é¢˜ï¼š** æ•°æ®æ²¡æœ‰æ›´æ–°

**æ’æŸ¥ï¼š**
1. æŸ¥çœ‹"æ•°æ®"æŒ‡æ ‡ï¼š
   - **ç¼“å­˜ (280s)** â†’ æ¥è¿‘ 5 åˆ†é’Ÿï¼Œå³å°†è‡ªåŠ¨åˆ·æ–°
   - **ç¼“å­˜ (30s)** â†’ åˆšåˆ·æ–°ä¸ä¹…ï¼Œæ•°æ®åº”è¯¥æ˜¯æœ€æ–°çš„

2. æ‰‹åŠ¨åˆ·æ–°ï¼š
   - ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®
   - è§‚å¯Ÿ"æ•°æ®"å˜ä¸º"å®æ—¶"

### åœºæ™¯ 3ï¼šæ€§èƒ½ç›‘æ§

**ç›®æ ‡ï¼š** ç›‘æ§ç½‘ç»œå»¶è¿Ÿ

**æ–¹æ³•ï¼š**
- è§‚å¯Ÿ"ç½‘ç»œ"æŒ‡æ ‡çš„å»¶è¿Ÿå€¼
- **< 50ms** â†’ æœ¬åœ°è®¿é—®ï¼Œæ€§èƒ½ä¼˜ç§€
- **50-200ms** â†’ å…¬ç½‘è®¿é—®ï¼Œæ€§èƒ½è‰¯å¥½
- **> 200ms** â†’ ç½‘ç»œç¼“æ…¢ï¼Œå¯èƒ½æœ‰é—®é¢˜

---

## ğŸ“Š ç›‘æ§æŒ‡æ ‡è¯´æ˜

### ç½‘ç»œæŒ‡æ ‡

| æ˜¾ç¤º | å«ä¹‰ | æ“ä½œå»ºè®® |
|------|------|----------|
| åœ¨çº¿ (10-50ms) | API Bridge å“åº”æ­£å¸¸ | âœ… æ— éœ€æ“ä½œ |
| åœ¨çº¿ (50-200ms) | ç½‘ç»œæœ‰å»¶è¿Ÿä½†å¯ç”¨ | âš ï¸ å…³æ³¨æ€§èƒ½ |
| åœ¨çº¿ (>200ms) | ç½‘ç»œç¼“æ…¢ | âš ï¸ æ£€æŸ¥ç½‘ç»œæˆ– cpolar |
| ç¦»çº¿ | API Bridge ä¸å¯è¾¾ | âŒ æ£€æŸ¥æœåŠ¡å’Œéš§é“ |

### æ•°æ®æŒ‡æ ‡

| æ˜¾ç¤º | å«ä¹‰ | æ“ä½œå»ºè®® |
|------|------|----------|
| å®æ—¶ | æ•°æ®åˆšä» Gateway æŸ¥è¯¢ | âœ… æ•°æ®æœ€æ–° |
| ç¼“å­˜ (0-60s) | 1 åˆ†é’Ÿå†…çš„ç¼“å­˜ | âœ… æ•°æ®è¶³å¤Ÿæ–° |
| ç¼“å­˜ (60-240s) | 2-4 åˆ†é’Ÿçš„ç¼“å­˜ | â„¹ï¸ æ•°æ®ä»ç„¶æœ‰æ•ˆ |
| ç¼“å­˜ (240-300s) | å³å°†åˆ·æ–° | â³ ç­‰å¾…è‡ªåŠ¨åˆ·æ–° |
| å¼‚å¸¸ | æ•°æ®åŠ è½½å¤±è´¥ | âŒ æ£€æŸ¥ Gateway |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æœ¬åœ°æµ‹è¯•

**1. ç½‘ç»œå¥åº·æ£€æŸ¥ï¼š**
```bash
# æµ‹è¯• health ç«¯ç‚¹
curl http://localhost:8081/api/health
# é¢„æœŸï¼š{"status":"ok","timestamp":"..."}

# æµ‹è¯•å“åº”æ—¶é—´
time curl -s http://localhost:8081/api/health > /dev/null
# é¢„æœŸï¼š< 0.05s
```

**2. æ•°æ®çŠ¶æ€æ£€æŸ¥ï¼š**
```bash
# æŸ¥è¯¢æ•°æ®çŠ¶æ€
curl -H "X-Ergo-Key: ergo-default-secret-key-2026" \
     http://localhost:8081/api/status | jq '._meta'
# é¢„æœŸï¼š{"cached": true, "cacheAge": 120, ...}
```

### å…¬ç½‘æµ‹è¯•

**åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼š**
```
https://terryzin.cpolar.top
```

**éªŒè¯è¦ç‚¹ï¼š**
1. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Network æ ‡ç­¾
2. è§‚å¯Ÿ `/api/health` è¯·æ±‚ï¼š
   - é¢‘ç‡ï¼šæ¯ 3 ç§’ä¸€æ¬¡
   - å“åº”æ—¶é—´ï¼š< 100ms
   - çŠ¶æ€ç ï¼š200 OK

3. è§‚å¯Ÿå‰ç«¯æ˜¾ç¤ºï¼š
   - "ç½‘ç»œ"æ˜¾ç¤º"åœ¨çº¿ (XXms)"
   - "æ•°æ®"æ˜¾ç¤º"ç¼“å­˜ (XXs)"æˆ–"å®æ—¶"

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœæ–°æ–¹æ¡ˆæœ‰é—®é¢˜ï¼Œå¯ä»¥å›æ»šï¼š

```bash
# å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬
git revert d0437b8

# æˆ–è€…æ£€å‡ºæ—§ç‰ˆæœ¬
git checkout b308459
```

**å›æ»šå½±å“ï¼š**
- âŒ å¤±å»ç½‘ç»œå®æ—¶ç›‘æ§
- âŒ æ¢å¤åˆ°å•ä¸€"ç¼“å­˜"æ˜¾ç¤º
- âœ… åŸºç¡€åŠŸèƒ½ä¸å—å½±å“

---

## ğŸ“ æœªæ¥ä¼˜åŒ–

### å¯èƒ½çš„æ”¹è¿›

1. **è‡ªé€‚åº”æ£€æµ‹é¢‘ç‡**
   ```javascript
   // ç½‘ç»œæ­£å¸¸ï¼šæ¯ 5 ç§’æ£€æµ‹
   // ç½‘ç»œå¼‚å¸¸ï¼šæ¯ 1 ç§’é‡è¯•
   const interval = networkHealthy ? 5000 : 1000;
   ```

2. **å»¶è¿Ÿå‘Šè­¦**
   ```javascript
   if (latency > 200) {
       showToast('ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜', 'warn');
   }
   ```

3. **å†å²è¶‹åŠ¿å›¾**
   - è®°å½•æœ€è¿‘ 1 å°æ—¶çš„å»¶è¿Ÿæ•°æ®
   - ç»˜åˆ¶æŠ˜çº¿å›¾æ˜¾ç¤ºè¶‹åŠ¿

4. **æ™ºèƒ½é‡è¿**
   - ç½‘ç»œæ¢å¤åè‡ªåŠ¨åˆ·æ–°æ•°æ®
   - é¿å…ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ

---

**æ›´æ–°æ—¥æœŸï¼š** 2026-02-20
**ç‰ˆæœ¬ï¼š** v1.3.0+
**ä½œè€…ï¼š** Ergo Team
**çŠ¶æ€ï¼š** âœ… å·²å®æ–½å¹¶æ¨é€
